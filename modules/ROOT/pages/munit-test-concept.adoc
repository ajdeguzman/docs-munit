= MUnit Test Structure Fundamentals
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:page-aliases: munit-suite.adoc

== MUnit Test Suite

The base file in the MUnit Framework is the MUnit Test Suite file. These files are the XML files located under the src/test/munit folder in your Mule application's folder structure. Each MUnit Test Suite file is a collection of MUnit tests. It is meant to work on its own, and should be able to run independently from other MUnit test suite files.

An MUnit test suite file should contain any combination of the following components:

* Before/After Suite
* Before/After Tests
* MUnit Tests

Each MUnit test suite file is, behind the scenes, no different than a Mule application XML file. You can use several of the Mule top level elements such as flow, sub-flow, and scripts.

=== MUnit Configuration

The MUnit configuration identifies a Mule XML file as a MUnit Suite file. This means that a MUnit Suite file will look something like this:

[source,xml,linenums]
----

<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:munit="http://www.mulesoft.org/schema/mule/munit" xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools  http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd">

	<munit:config name="A MUnit Suite" />

	<!-- Tests -->

</mule>

----

==== Ignoring a suite

To ignore a whole suite from running, you can use the `ignore` attribute of the configuration.

[source,xml]
----
<munit:config name="A MUnit Suite" ignore="true"/>
----

==== Minimum Mule Version

To specify that a suite should run if the Mule version is equal or newer than a specific version, you can use the
`minMuleVersion` attribute of the configuration.

[source,xml]
----
<munit:config name="A MUnit Suite" minMuleVersion="4.1.4"/>
----

== MUnit Test

The MUnit Test is the basic processor of an MUnit Test Suite. It represents each test scenario you want to try.

The MUnit Test is divided in three scopes:

[%header,cols="20,80"]
|===
|Scope |Description

| Behavior
| The behavior scope is meant to set all the preconditions before executing the test logic.

| Execution
| The execution scope is meant to have the testing logic which will wait for all processes to finish before executing the next scope.

| Validation
| The validation scope is meant to have all the validations regarding the result of the execution scope.
|===

All these scopes are optional.

[source,xml,linenums]
----

<munit:test name="exampleTest" description="Test to verify scenario 1">>

     <munit:behavior>
         <!-- Processors to set preconditions for the test -->
     </munit:behavior>

     <munit:execution>
         <flow-ref name="exampleFlow"/>
     </munit:execution>

     <munit:validation>
         <!-- Processors to validate result -->
     </munit:validation>
 </munit:test>

----

.A Studio representation of the MUnit Test
image::munit-test-concept-9c736.png[munit-test]


=== MUnit Test Description Attribute

Ideally, you should write a useful, representative description of the scenario you are testing. This description displays in the test console before running the test, and also in the reports. +
The more representative the description, the easier to read and troubleshoot any failures.

=== Ignoring a Test

There may be scenarios where you need to shut down a test. Whether this be because the test is failing or because it has nasty side effects. +
The point is you shouldn't have to comment out the code.

In this case, MUnit allows you to ignore a specific test.

You can ignore any of your tests by adding the ignore boolean to the test definition.

[source,xml,linenums]
----
<munit:test name="my-flow-Test"
      ignore="true"
      description="Test to verify scenario 1">
</munit:test>
----

[TIP]
Valid values for `ignore` are true and false. If the attribute is not present, the default is false.

.In Anypoint Studio, you can check the Ignore Test option.
image::munit-test-concept-de4c9.png[ignore-test]

The `ignore` attribute also allows you to use expressions to ignore a test based on the current mule version or on the current OS.

.Ignoring a test based on the mule version
[source,xml]
----
<munit:test name="mule-version-ignore-test" ignore="#[Munit::muleVersionPriorTo('4.1.4')]">
----

This test will be ignored if the Mule version is prior to `4.1.4`. Other possible functions are `muleVersionEqualTo` and
`muleVersionNewerThan`.

.Ignoring a test based on the Operating System
[source,xml]
----
<munit:test name="linux-ignore-test" ignore="#[Munit::osEqualTo('Mac OS X')]">
----


=== Test TimeOut Attribute

Each MUnit test will automatically fail if it takes more than 2 minutes to complete. Sometimes, that time can be too long or too short. +
In that case, you can use the `timeOut` attribute, where you can set the desired maximum time -in milliseconds- that the test can run before failing. For example:

[source,xml,linenums]
----
<munit:test
  name="custom-timeout-test"
  description="This test has a timeout of 10 seconds"
  timeOut="10000" >
  ....
</munit:test>
----

== Test Tag Attribute

MUnit also allows you to tag your tests, so you can choose to run tests under a specific tag. For example:

[source,xml,linenums]
----
<munit:test
  name="exampleTest"
  description="A test that works as an example"
  ignore="true"
  tags="integration,http" >
		â€¦
</munit:test>
----

.In Anypoint Studio, you can define tags in the proper field.
image::munit-test-concept-c2d9f.png[test-tags]

=== MUnit Test Expected Error and Exception Attributes

Sometimes, the only thing you want to validate is that the flow or sub-flow you are testing fails and throws a specific error, which depends on the business logic being tested. In these cases, MUnit provides a simple way to validate the scenario. +
You can add the attributes `expectedErrorType`, `expectException`, and `expectedErrorDescription`, as shown below:

[source,xml,linenums]
----
<munit:test name="MUnit-test-suite"
  description="A test that works as an example"
  expectedErrorType="RETRY_EXHAUSTED"
  expectedException="java.lang.RuntimeException"
  expectedErrorDescription="retries exhausted">
  ...
</munit:test>
----

.A visual representation on Anypoint Studio
image::munit-test-concept-e7280.png[]

* The `expectedErrorType` attribute expects an error ID that needs to be defined inside the application being tested. +
This attribute allows you to validate that a defined error type in your application is thrown. If you define an `errorType` that does not exists in your application, the test does not run.
+
[source,xml,linenums]
----
<munit:test name="MUnit-test-suite"
  description="Test Error Type"
  expectedErrorType="FTP:ILLEGAL_PATH">
  ...
</munit:test>
----
+
This Error Type test expects that an FTP operation will throw an `FTP:ILLEGAL_PATH` error. +
If none of your flows are using using an FTP connector, then the error type is not defined within your application and the test will not run.
+
[TIP]
ErrorTypes that belong to the Mule Runtime do not need to be typified. For example, `MULE:RETRY_EXHAUSTED` can be defined as simply `RETRY_EXHAUSTED`.

* The attribute `expectException` expects a literal exception class name (canonical form). +
When you provide a literal value, it should take the form of the canonical class name of the exception that is expected. In these cases, Mule always throws a `MuleMessagingException`. MUnit validates the provided classname if the underlying cause of the `MuleMessagingException` thrown is of the exact same type.
+
[source,xml,linenums]
----
<munit:test name="testExceptions"
  description="Test Exceptions"
  expectedException="java.lang.RuntimeException">
  ...
</munit:test>
----
+
If you define that your test expects an exception and none is thrown, the test fails immediately.

* The attribute expectedErrorDescription expects an error description. +
This attribute allows you to validate that an error is thrown and this error has description that is equals or contains the expected error description. If you define that your test expects an error and none is thrown or the error thrown description doesn't match, the test fails immediately.
+
[source,xml,linenums]
----
<munit:test name="testExpectedErrorDescription"
  description="Test Expected Error Description Attribute"
  expectedErrorDescription="An error has occurred">
  ...
</munit:test>
----

==== Before / After Scopes

As with other testing frameworks, MUnit provides certain features around the test suite concept. In particular, it provides a set of scopes that allow you to add processing or actions to be run before and/or after the entire MUnit Test or MUnit Suite executions:

* Before and After Suite Scopes.
* Before and After Test Scopes.

The ID space from each component must be unique across all your application. The before and after scopes cannot share the same name between them, nor have the same name as any flow in your application.


== See Also

* xref:enable-flow-sources-concept.adoc[About Enable Flow Sources]
* xref:before-after-scopes-concept.adoc[About Before/After Scopes]
* xref:before-after-scopes-reference.adoc[Before/After Scopes Reference]
* xref:munit-test-reference.adoc[MUnit Test Reference]